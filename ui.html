<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Shadcn 스타일 기반 CSS */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      margin: 0;
      padding: 0;
      background: #ffffff;
      color: #0f172a;
      line-height: 1.5;
    }
    
    .container {
      padding: 16px;
      max-width: 100%;
    }
    
    .header {
      margin-bottom: 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 4px 0;
      color: #0f172a;
    }
    
    .header p {
      font-size: 14px;
      color: #64748b;
      margin: 0;
    }
    
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 16px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      min-height: 36px;
    }
    
    .btn-primary {
      background: #0f172a;
      color: #ffffff;
      border-color: #0f172a;
    }
    
    .btn-primary:hover {
      background: #1e293b;
      border-color: #1e293b;
    }
    
    .btn-secondary {
      background: #f8fafc;
      color: #0f172a;
      border-color: #e2e8f0;
    }
    
    .btn-secondary:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    .btn-outline {
      background: transparent;
      color: #0f172a;
      border-color: #e2e8f0;
    }
    
    .btn-outline:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }
    
    .btn-success {
      background: #10b981;
      color: #ffffff;
      border-color: #10b981;
    }
    
    .btn-success:hover {
      background: #059669;
      border-color: #059669;
    }
    
    .btn-info {
      background: #3b82f6;
      color: #ffffff;
      border-color: #3b82f6;
    }
    
    .btn-info:hover {
      background: #2563eb;
      border-color: #2563eb;
    }
    
    .card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .card-header {
      margin-bottom: 12px;
    }
    
    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 4px 0;
      color: #0f172a;
    }
    
    .card-description {
      font-size: 12px;
      color: #64748b;
      margin: 0;
    }
    
    .analysis-section {
      margin-bottom: 16px;
    }
    
    .analysis-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .analysis-item:last-child {
      border-bottom: none;
    }
    
    .analysis-label {
      font-size: 13px;
      color: #64748b;
    }
    
    .analysis-value {
      font-size: 13px;
      font-weight: 500;
      color: #0f172a;
    }
    
    .confidence-bar {
      width: 60px;
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
    }
    
    .confidence-fill {
      height: 100%;
      background: #10b981;
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    
    .suggestions-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .suggestion-item {
      font-size: 12px;
      color: #64748b;
      padding: 4px 0;
      border-left: 2px solid #e2e8f0;
      padding-left: 8px;
      margin-bottom: 4px;
    }
    
    .keyword-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }
    
    .keyword-tag {
      background: #f1f5f9;
      color: #475569;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
    }
    
    .preview-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
    }
    
    .preview-title {
      font-size: 13px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: #0f172a;
    }
    
    .preview-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .preview-item:last-child {
      border-bottom: none;
    }
    
    .preview-before {
      font-size: 12px;
      color: #64748b;
      flex: 1;
    }
    
    .preview-arrow {
      color: #94a3b8;
      margin: 0 8px;
      font-size: 12px;
    }
    
    .preview-after {
      font-size: 12px;
      color: #059669;
      font-weight: 500;
      flex: 1;
      text-align: right;
    }
    
    .pattern-category {
      margin-bottom: 12px;
    }
    
    .pattern-category-title {
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      margin: 0 0 6px 0;
      padding: 4px 8px;
      background: #f3f4f6;
      border-radius: 4px;
      display: inline-block;
    }
    
    .pattern-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      font-size: 11px;
    }
    
    .pattern-description {
      color: #6b7280;
      font-size: 10px;
      font-style: italic;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #64748b;
    }
    
    .loading.show {
      display: block;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 50%;
      border-top-color: #0f172a;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .tone-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .tone-friendly {
      background: #dcfce7;
      color: #166534;
    }
    
    .tone-professional {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .tone-enthusiastic {
      background: #fef3c7;
      color: #92400e;
    }
    
    .tone-playful {
      background: #f3e8ff;
      color: #7c3aed;
    }
    
    .tone-neutral {
      background: #f1f5f9;
      color: #475569;
    }
    
    /* 선택적 변환 UI 스타일 */
    .conversion-suggestions {
      margin-bottom: 16px;
    }
    
    .suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .suggestion-count {
      font-size: 12px;
      color: #64748b;
    }
    
    .suggestion-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: #10b981;
    }
    
    .suggestion-item-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .suggestion-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .suggestion-node-name {
      font-size: 11px;
      color: #64748b;
      font-weight: 500;
    }
    
    .suggestion-checkbox {
      width: 16px;
      height: 16px;
      accent-color: #10b981;
    }
    
    .suggestion-text {
      margin-bottom: 8px;
    }
    
    .suggestion-original {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 4px;
    }
    
    .suggestion-converted {
      font-size: 12px;
      color: #059669;
      font-weight: 500;
      background: #f0fdf4;
      padding: 4px 6px;
      border-radius: 4px;
    }
    
    .suggestion-patterns {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }
    
    .pattern-badge {
      background: #f1f5f9;
      color: #475569;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid #e2e8f0;
    }
    
    .pattern-badge.dolgo {
      background: #fef3c7;
      color: #92400e;
      border-color: #fde68a;
    }
    
    /* 돌고만 가이드 스타일 */
    .dolgo-guide {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    
    .dolgo-guide-title {
      font-size: 13px;
      font-weight: 600;
      color: #92400e;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .dolgo-guide-content {
      font-size: 11px;
      color: #92400e;
      line-height: 1.4;
    }
    
    .dolgo-guide-list {
      margin: 6px 0;
      padding-left: 16px;
    }
    
    .dolgo-guide-list li {
      margin-bottom: 2px;
    }
    
    /* 프레임 선택 스타일 */
    .frame-selection {
      margin-bottom: 16px;
    }
    
    .frame-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background: #ffffff;
    }
    
    .frame-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .frame-item:last-child {
      border-bottom: none;
    }
    
    .frame-item:hover {
      background: #f8fafc;
    }
    
    .frame-item.selected {
      background: #eff6ff;
      border-color: #3b82f6;
    }
    
    .frame-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .frame-name {
      font-size: 13px;
      font-weight: 500;
      color: #0f172a;
    }
    
    .frame-stats {
      font-size: 11px;
      color: #64748b;
    }
    
    .frame-select-radio {
      width: 16px;
      height: 16px;
      accent-color: #3b82f6;
    }
    
    .empty-frame-list {
      padding: 20px;
      text-align: center;
      color: #64748b;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🎯 DOLGO Verbal System</h1>
      <p>한국어 UX Writing 친근한 톤 변환</p>
    </div>
    
    <!-- 돌고만의 기본 용어 시스템 가이드 -->
    <div class="dolgo-guide">
      <div class="dolgo-guide-title">
        🏢 돌고만의 기본 용어 시스템
      </div>
      <div class="dolgo-guide-content">
        <strong>핵심 단어:</strong> 하기, 돼요, 이에요, 있어요<br>
        <strong>스타일:</strong> 사용자 친화적이고 직관적인 표현
        <ul class="dolgo-guide-list">
          <li>기부 관련 용어 통일 (나눔/후원/함께하기 → 기부)</li>
          <li>모금과 사연 개념 구분 (정기모금/일시모금 → 정기사연/일시사연)</li>
          <li>기부재단 등 전문 용어 정확한 사용</li>
        </ul>
      </div>
    </div>
    
    <div class="button-group">
      <button id="generate-suggestions-btn" class="btn btn-primary">선택한 요소의 변환 패턴 미리보기</button>
      <button id="browse-frames-btn" class="btn btn-info">프레임 목록에서 선택하기</button>
      <button id="apply-selected-btn" class="btn btn-success hidden">선택된 텍스트에 친근한 톤 적용하기</button>
      <button id="convert-all-btn" class="btn btn-outline">모든 텍스트 변환</button>
      <button id="cancel-btn" class="btn btn-outline">닫기</button>
    </div>
    
    <!-- 프레임 선택 섹션 -->
    <div id="frame-selection" class="frame-selection hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">📁 프레임 선택</h3>
          <p class="card-description">변환할 텍스트가 포함된 프레임을 선택하세요</p>
        </div>
        
        <div id="frame-list" class="frame-list">
          <div class="empty-frame-list">프레임 목록을 불러오는 중...</div>
        </div>
        
        <div class="button-group" style="margin-top: 12px;">
          <button id="analyze-frame-btn" class="btn btn-primary hidden">선택한 프레임 분석하기</button>
          <button id="back-to-main-btn" class="btn btn-secondary">뒤로가기</button>
        </div>
      </div>
    </div>
    
    <div id="loading" class="loading">
      <div class="spinner"></div>
      텍스트를 분석하고 있습니다...
    </div>
    
    <!-- 변환 제안 섹션 -->
    <div id="conversion-suggestions" class="conversion-suggestions hidden">
      <div class="suggestion-header">
        <div class="card-title">변환 패턴 미리보기</div>
        <div id="suggestion-count" class="suggestion-count">0개</div>
      </div>
      
      <div class="suggestion-controls">
        <div class="checkbox-group">
          <input type="checkbox" id="select-all" checked>
          <label for="select-all">모두 선택</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="select-none">
          <label for="select-none">선택 해제</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="editable-only">
          <label for="editable-only">편집 가능만</label>
        </div>
      </div>
      
      <div id="suggestions-list">
        <!-- 변환 제안들이 여기에 동적으로 추가됩니다 -->
      </div>
    </div>
    
    <div id="analysis-results" class="hidden">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">📊 톤 프로파일 분석</h3>
          <p class="card-description">선택한 텍스트의 UX Writing 톤을 분석했습니다</p>
        </div>
        
        <div id="tone-profile" class="analysis-section">
          <!-- 톤 프로파일이 여기에 동적으로 추가됩니다 -->
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">🔍 변환 미리보기</h3>
          <p class="card-description">적용 가능한 변환 항목들을 확인하세요</p>
        </div>
        
        <div id="preview-section" class="preview-section">
          <div class="preview-title">변환 예시</div>
          <div id="preview-items">
            <!-- 미리보기 항목들이 여기에 동적으로 추가됩니다 -->
          </div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">💡 UX Writing 패턴</h3>
        <p class="card-description">카테고리별 변환 패턴</p>
      </div>
      
      <div class="pattern-category">
        <div class="pattern-category-title">돌고만의 기본 용어 시스템</div>
        <div class="pattern-item">
          <span class="preview-before">나눔</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">기부</span>
          <span class="pattern-description">기부를 일관되게 표현하기</span>
        </div>
        <div class="pattern-item">
          <span class="preview-before">후원</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">기부</span>
          <span class="pattern-description">기부를 일관되게 표현하기</span>
        </div>
        <div class="pattern-item">
          <span class="preview-before">정기모금</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">정기사연</span>
          <span class="pattern-description">모금과 사연 개념 구분</span>
        </div>
      </div>
      
      <div class="pattern-category">
        <div class="pattern-category-title">명령형 → 제안형</div>
        <div class="pattern-item">
          <span class="preview-before">확인해보세요</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">확인하기</span>
          <span class="pattern-description">친근한 어조</span>
        </div>
        <div class="pattern-item">
          <span class="preview-before">이용해보세요</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">이용하기</span>
          <span class="pattern-description">간결한 표현</span>
        </div>
        <div class="pattern-item">
          <span class="preview-before">참여해보세요</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">참여하기</span>
          <span class="pattern-description">직접적 유도</span>
        </div>
      </div>
      
      <div class="pattern-category">
        <div class="pattern-category-title">격식체 → 친근체</div>
        <div class="pattern-item">
          <span class="preview-before">됩니다</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">돼요</span>
          <span class="pattern-description">친근한 확인</span>
        </div>
        <div class="pattern-item">
          <span class="preview-before">입니다</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">이에요</span>
          <span class="pattern-description">부드러운 설명</span>
        </div>
        <div class="pattern-item">
          <span class="preview-before">있습니다</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">있어요</span>
          <span class="pattern-description">친근한 안내</span>
        </div>
      </div>
      
      <div class="pattern-category">
        <div class="pattern-category-title">격식적 표현 → 친근한 표현</div>
        <div class="pattern-item">
          <span class="preview-before">하시면</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">하면</span>
          <span class="pattern-description">간결한 조건</span>
        </div>
        <div class="pattern-item">
          <span class="preview-before">하십시오</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">해주세요</span>
          <span class="pattern-description">정중한 요청</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // UI 상태 관리
    let suggestions = [];
    let selectedNodeIds = [];
    let selectedFrameId = null;
    let frames = [];
    
    // DOM 요소들
    const generateSuggestionsBtn = document.getElementById('generate-suggestions-btn');
    const browseFramesBtn = document.getElementById('browse-frames-btn');
    const applySelectedBtn = document.getElementById('apply-selected-btn');
    const convertAllBtn = document.getElementById('convert-all-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const loading = document.getElementById('loading');
    const conversionSuggestions = document.getElementById('conversion-suggestions');
    const analysisResults = document.getElementById('analysis-results');
    const suggestionsList = document.getElementById('suggestions-list');
    const suggestionCount = document.getElementById('suggestion-count');
    const selectAllCheckbox = document.getElementById('select-all');
    const selectNoneCheckbox = document.getElementById('select-none');
    const editableOnlyCheckbox = document.getElementById('editable-only');
    
    // 프레임 선택 관련 요소들
    const frameSelection = document.getElementById('frame-selection');
    const frameList = document.getElementById('frame-list');
    const analyzeFrameBtn = document.getElementById('analyze-frame-btn');
    const backToMainBtn = document.getElementById('back-to-main-btn');
    
    // 이벤트 리스너
    generateSuggestionsBtn.addEventListener('click', () => {
      showLoading();
      parent.postMessage({ pluginMessage: { type: 'generate-suggestions' } }, '*');
    });
    
    browseFramesBtn.addEventListener('click', () => {
      showFrameSelection();
      parent.postMessage({ pluginMessage: { type: 'get-frame-list' } }, '*');
    });
    
    analyzeFrameBtn.addEventListener('click', () => {
      if (selectedFrameId) {
        showLoading();
        hideFrameSelection();
        parent.postMessage({ 
          pluginMessage: { 
            type: 'generate-suggestions-for-frame', 
            data: { frameId: selectedFrameId } 
          } 
        }, '*');
      } else {
        alert('프레임을 선택해주세요.');
      }
    });
    
    backToMainBtn.addEventListener('click', () => {
      hideFrameSelection();
    });
    
    applySelectedBtn.addEventListener('click', () => {
      const selectedIds = getSelectedNodeIds();
      if (selectedIds.length > 0) {
        if (selectedFrameId) {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'apply-selected-suggestions-for-frame', 
              data: { 
                frameId: selectedFrameId,
                selectedNodeIds: selectedIds 
              } 
            } 
          }, '*');
        } else {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'apply-selected-suggestions', 
              data: { selectedNodeIds: selectedIds } 
            } 
          }, '*');
        }
      } else {
        alert('선택된 항목이 없습니다.');
      }
    });
    
    convertAllBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'convert-all' } }, '*');
    });
    
    cancelBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    });
    
    // 체크박스 이벤트
    selectAllCheckbox.addEventListener('change', () => {
      if (selectAllCheckbox.checked) {
        selectAllSuggestions();
      }
    });
    
    selectNoneCheckbox.addEventListener('change', () => {
      if (selectNoneCheckbox.checked) {
        selectNoSuggestions();
      }
    });
    
    editableOnlyCheckbox.addEventListener('change', () => {
      filterEditableSuggestions();
    });
    
    // 프레임 선택 표시
    function showFrameSelection() {
      frameSelection.classList.remove('hidden');
      conversionSuggestions.classList.add('hidden');
      analysisResults.classList.add('hidden');
      applySelectedBtn.classList.add('hidden');
    }
    
    // 프레임 선택 숨기기
    function hideFrameSelection() {
      frameSelection.classList.add('hidden');
      selectedFrameId = null;
    }
    
    // 로딩 표시
    function showLoading() {
      loading.classList.add('show');
      conversionSuggestions.classList.add('hidden');
      analysisResults.classList.add('hidden');
      applySelectedBtn.classList.add('hidden');
    }
    
    // 로딩 숨기기
    function hideLoading() {
      loading.classList.remove('show');
    }
    
    // 프레임 목록 렌더링
    function renderFrameList(framesData) {
      frames = framesData;
      frameList.innerHTML = '';
      
      if (framesData.length === 0) {
        frameList.innerHTML = '<div class="empty-frame-list">텍스트가 포함된 프레임이 없습니다.</div>';
        return;
      }
      
      framesData.forEach(frame => {
        const frameItem = document.createElement('div');
        frameItem.className = 'frame-item';
        frameItem.dataset.frameId = frame.id;
        
        frameItem.innerHTML = `
          <div class="frame-info">
            <div class="frame-name">${frame.name}</div>
            <div class="frame-stats">텍스트 ${frame.textCount}개 | 변환 가능 ${frame.convertibleCount}개</div>
          </div>
          <input type="radio" name="frame-select" class="frame-select-radio" value="${frame.id}">
        `;
        
        frameItem.addEventListener('click', () => {
          // 모든 프레임 아이템에서 selected 클래스 제거
          document.querySelectorAll('.frame-item').forEach(item => {
            item.classList.remove('selected');
          });
          
          // 현재 프레임 아이템에 selected 클래스 추가
          frameItem.classList.add('selected');
          
          // 라디오 버튼 선택
          const radio = frameItem.querySelector('.frame-select-radio');
          radio.checked = true;
          
          selectedFrameId = frame.id;
          analyzeFrameBtn.classList.remove('hidden');
        });
        
        frameList.appendChild(frameItem);
      });
    }
    
    // 제안 목록 렌더링
    function renderSuggestions(suggestionsData) {
      suggestions = suggestionsData;
      selectedNodeIds = suggestionsData.map(s => s.nodeId);
      
      suggestionsList.innerHTML = '';
      
      if (suggestionsData.length === 0) {
        suggestionsList.innerHTML = '<p style="color: #64748b; font-size: 12px; text-align: center; padding: 20px;">변환할 텍스트가 없습니다.</p>';
        return;
      }
      
      suggestionsData.forEach(suggestion => {
        const suggestionCard = document.createElement('div');
        suggestionCard.className = 'suggestion-item-card';
        
        const patternsHtml = suggestion.patterns.map(pattern => {
          const badgeClass = pattern.category === 'dolgo' ? 'pattern-badge dolgo' : 'pattern-badge';
          return `<span class="${badgeClass}">${pattern.description}</span>`;
        }).join('');
        
        suggestionCard.innerHTML = `
          <div class="suggestion-item-header">
            <div class="suggestion-node-name">${suggestion.nodeName}</div>
            <input type="checkbox" class="suggestion-checkbox" data-node-id="${suggestion.nodeId}" checked>
          </div>
          <div class="suggestion-text">
            <div class="suggestion-original">원본: ${suggestion.originalText}</div>
            <div class="suggestion-converted">변환: ${suggestion.convertedText}</div>
          </div>
          <div class="suggestion-patterns">
            ${patternsHtml}
          </div>
        `;
        
        suggestionsList.appendChild(suggestionCard);
      });
      
      // 체크박스 이벤트 추가
      document.querySelectorAll('.suggestion-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
      });
      
      updateSelectedCount();
    }
    
    // 선택된 항목 수 업데이트
    function updateSelectedCount() {
      const selectedCheckboxes = document.querySelectorAll('.suggestion-checkbox:checked');
      const totalCheckboxes = document.querySelectorAll('.suggestion-checkbox');
      
      suggestionCount.textContent = `${selectedCheckboxes.length}개`;
      
      // 전체 선택 체크박스 상태 업데이트
      selectAllCheckbox.checked = selectedCheckboxes.length === totalCheckboxes.length;
      selectNoneCheckbox.checked = selectedCheckboxes.length === 0;
    }
    
    // 모든 제안 선택
    function selectAllSuggestions() {
      document.querySelectorAll('.suggestion-checkbox').forEach(checkbox => {
        checkbox.checked = true;
      });
      updateSelectedCount();
    }
    
    // 모든 제안 선택 해제
    function selectNoSuggestions() {
      document.querySelectorAll('.suggestion-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      updateSelectedCount();
    }
    
    // 편집 가능한 항목만 필터링
    function filterEditableSuggestions() {
      const checkboxes = document.querySelectorAll('.suggestion-checkbox');
      checkboxes.forEach((checkbox, index) => {
        const suggestion = suggestions[index];
        if (suggestion) {
          const card = checkbox.closest('.suggestion-item-card');
          if (editableOnlyCheckbox.checked) {
            card.style.display = suggestion.editable ? 'block' : 'none';
          } else {
            card.style.display = 'block';
          }
        }
      });
    }
    
    // 선택된 노드 ID들 가져오기
    function getSelectedNodeIds() {
      const selectedCheckboxes = document.querySelectorAll('.suggestion-checkbox:checked');
      return Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.nodeId);
    }
    
    // 톤 배지 생성
    function createToneBadge(tone) {
      const badge = document.createElement('span');
      badge.className = `tone-badge tone-${tone}`;
      badge.textContent = tone;
      return badge;
    }
    
    // 신뢰도 바 생성
    function createConfidenceBar(confidence) {
      const bar = document.createElement('div');
      bar.className = 'confidence-bar';
      
      const fill = document.createElement('div');
      fill.className = 'confidence-fill';
      fill.style.width = `${confidence * 100}%`;
      
      bar.appendChild(fill);
      return bar;
    }
    
    // 톤 프로파일 렌더링
    function renderToneProfile(profiles) {
      const toneProfileDiv = document.getElementById('tone-profile');
      toneProfileDiv.innerHTML = '';
      
      if (profiles.length === 0) {
        toneProfileDiv.innerHTML = '<p style="color: #64748b; font-size: 13px;">분석할 텍스트가 없습니다.</p>';
        return;
      }
      
      profiles.forEach((profile, index) => {
        const profileDiv = document.createElement('div');
        profileDiv.className = 'analysis-section';
        
        if (profiles.length > 1) {
          const title = document.createElement('h4');
          title.style.fontSize = '13px';
          title.style.margin = '0 0 8px 0';
          title.style.color = '#0f172a';
          title.textContent = `텍스트 ${index + 1}`;
          profileDiv.appendChild(title);
        }
        
        // 문장 스타일
        const sentenceStyleDiv = document.createElement('div');
        sentenceStyleDiv.className = 'analysis-item';
        sentenceStyleDiv.innerHTML = `
          <span class="analysis-label">문장 스타일</span>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span class="analysis-value">${profile.sentenceStyle.type}</span>
            ${createConfidenceBar(profile.sentenceStyle.confidence).outerHTML}
          </div>
        `;
        profileDiv.appendChild(sentenceStyleDiv);
        
        // 감정 톤
        const emotionDiv = document.createElement('div');
        emotionDiv.className = 'analysis-item';
        emotionDiv.innerHTML = `
          <span class="analysis-label">감정 톤</span>
          <div style="display: flex; align-items: center; gap: 8px;">
            ${createToneBadge(profile.emotion.tone).outerHTML}
            ${createConfidenceBar(profile.emotion.confidence).outerHTML}
          </div>
        `;
        profileDiv.appendChild(emotionDiv);
        
        // 전체 톤
        const overallToneDiv = document.createElement('div');
        overallToneDiv.className = 'analysis-item';
        overallToneDiv.innerHTML = `
          <span class="analysis-label">전체 톤</span>
          <span class="analysis-value">${profile.overallTone}</span>
        `;
        profileDiv.appendChild(overallToneDiv);
        
        // 적용 가능한 패턴
        if (profile.patterns && profile.patterns.length > 0) {
          const patternsDiv = document.createElement('div');
          patternsDiv.className = 'analysis-item';
          patternsDiv.innerHTML = `
            <span class="analysis-label">적용 가능한 패턴</span>
            <span class="analysis-value">${profile.patterns.length}개</span>
          `;
          profileDiv.appendChild(patternsDiv);
        }
        
        // 키워드
        if (profile.keywords.keywords.length > 0) {
          const keywordsDiv = document.createElement('div');
          keywordsDiv.className = 'analysis-item';
          keywordsDiv.innerHTML = `
            <span class="analysis-label">주요 키워드</span>
            <div class="keyword-tags">
              ${profile.keywords.keywords.slice(0, 5).map(keyword => 
                `<span class="keyword-tag">${keyword}</span>`
              ).join('')}
            </div>
          `;
          profileDiv.appendChild(keywordsDiv);
        }
        
        // 제안사항
        if (profile.suggestions.length > 0) {
          const suggestionsDiv = document.createElement('div');
          suggestionsDiv.className = 'analysis-item';
          suggestionsDiv.innerHTML = `
            <span class="analysis-label">제안사항</span>
            <ul class="suggestions-list">
              ${profile.suggestions.map(suggestion => 
                `<li class="suggestion-item">${suggestion}</li>`
              ).join('')}
            </ul>
          `;
          profileDiv.appendChild(suggestionsDiv);
        }
        
        toneProfileDiv.appendChild(profileDiv);
      });
    }
    
    // 미리보기 렌더링
    function renderPreview(profiles) {
      const previewItemsDiv = document.getElementById('preview-items');
      previewItemsDiv.innerHTML = '';
      
      if (profiles.length === 0) {
        previewItemsDiv.innerHTML = '<p style="color: #64748b; font-size: 12px;">변환할 항목이 없습니다.</p>';
        return;
      }
      
      // 기본 변환 예시들
      const defaultConversions = [
        { before: '확인해보세요', after: '확인하기', description: '친근한 어조' },
        { before: '이용해보세요', after: '이용하기', description: '간결한 표현' },
        { before: '참여해보세요', after: '참여하기', description: '직접적 유도' },
        { before: '됩니다', after: '돼요', description: '친근한 확인' },
        { before: '입니다', after: '이에요', description: '부드러운 설명' },
        { before: '있습니다', after: '있어요', description: '친근한 안내' }
      ];
      
      defaultConversions.forEach(conversion => {
        const item = document.createElement('div');
        item.className = 'preview-item';
        item.innerHTML = `
          <span class="preview-before">${conversion.before}</span>
          <span class="preview-arrow">→</span>
          <span class="preview-after">${conversion.after}</span>
          <span class="pattern-description">${conversion.description}</span>
        `;
        previewItemsDiv.appendChild(item);
      });
    }
    
    // 제안 결과 처리
    function handleSuggestionsResult(suggestionsData) {
      renderSuggestions(suggestionsData);
      
      hideLoading();
      conversionSuggestions.classList.remove('hidden');
      applySelectedBtn.classList.remove('hidden');
    }
    
    // 분석 결과 처리
    function handleAnalysisResult(profiles) {
      renderToneProfile(profiles);
      renderPreview(profiles);
      
      hideLoading();
      analysisResults.classList.remove('hidden');
    }
    
    // 프레임 목록 결과 처리
    function handleFrameListResult(framesData) {
      renderFrameList(framesData);
    }
    
    // 메시지 수신
    window.addEventListener('message', (event) => {
      const message = event.data.pluginMessage;
      
      if (message.type === 'suggestions-result') {
        handleSuggestionsResult(message.suggestions);
      } else if (message.type === 'analysis-result') {
        handleAnalysisResult(message.profiles);
      } else if (message.type === 'frame-list-result') {
        handleFrameListResult(message.frames);
      }
    });
  </script>
</body>
</html>
